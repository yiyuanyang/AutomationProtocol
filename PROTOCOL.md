# Agent Coding Protocol v2.0

*Evolved from TheResearcher build loop — lessons learned 2026-02-20*

This document defines the rules for the AI build loop. All agents and orchestrators must follow it.

---

## Core Principles

### 1. Script Is Law, Model Executes Tasks

The orchestration script owns all routing, state transitions, and control flow. The model's only job is to do the task it was assigned (propose, review, implement, verify).

- All status/routing logic lives in the script, not in prompt instructions
- All valid state transitions are enumerated in code
- When a new edge case appears, fix the script — not the prompt
- A model should never decide "what happens next"

### 2. Fresh Instances, File-Based Context

Every agent invocation gets a blank-slate model. No persistent session. No accumulated conversation history.

Context is provided entirely through files read at the start of each run:
- Protocol files (this doc, EXECUTION_PLAN.md)
- State file (.review-loop-state.json)
- Task-specific prompt file (generated by the script for this exact run)
- Review/response files
- CODEBASE.md

### 3. Review Scope Isolation

A reviewer (Codex) should only see the changes under review. Not the entire codebase history, not 20 rounds of accumulated context.

In a PR-based flow, the reviewer receives:
1. The diff (`git diff main...feature-branch`)
2. The PR description (explicit intent)
3. Filtered mandates relevant to this specific change

No full-file reads of protocol docs. No historical review rounds. Isolated context = accurate review.

---

## 1. State Machine

The loop has one current step and moves through these phases in order:

```
propose → review → execute → verify → [advance to next step]
```

Valid transitions (script-enforced):

| Current Phase | Flag Status | Next Phase | Next Agent |
|--------------|-------------|------------|------------|
| propose | proposed | review | codex |
| review | approved | execute | claude-code |
| review | reviewed (CRs) | review | claude-code |
| execute | executed | verify | codex |
| verify | verified-clean | advance | — |
| verify | reviewed (CRs) | verify | claude-code |

**No agent may write `.review-loop-state.json` directly.** All transitions go through the loop script.

---

## 2. Flag Protocol

When an agent completes its work it writes `.agent-status.json`:

```json
{
  "agent": "claude-code",
  "step": "5",
  "status": "proposed",
  "nextAgent": "codex",
  "timestamp": "2026-01-01T00:00:00Z"
}
```

**Valid `status` values (enum):**
- `proposed`, `revised` — from Claude Code after proposal
- `approved` — from Codex when proposal accepted
- `reviewed` — from Codex when CRs raised
- `executed` — from Claude Code after implementation
- `verified-clean` — from Codex when verification passes
- `blocked` — when external dependency blocks progress

**Valid `nextAgent` values:**
- `claude-code` — implementation or CR fixes
- `codex` — review or verification
- `advance` — step completion, advance to next
- `escalate` — human intervention required (new in v2.0)

**Flag validation (script-enforced):**
- All fields required
- `step` must match `currentStep` in state file
- `status` must be in the valid enum
- `nextAgent` must be in the valid set
- `timestamp` must be within the last 30 minutes
- `agent` field must match expected agent for this phase

Rejected flags are renamed to `.agent-status.json.rejected` and the loop continues. Repeated rejections trigger escalation.

---

## 3. Owner Mandates & Protected Files

### Protected Files (owner-only, agent read-only)

Agents must NEVER write to:
- `EXECUTION_PLAN.md` — product plan
- `DECISIONS.md` — architectural decisions
- `AGENT_CODING_PROTOCOL.md` — this document
- `scripts/owner-mandates.json` — owner directives

**Violations of this rule are critical protocol breaches.** Two incidents:
- Issue 14: Agent fabricated state file with fake Step 20 completion
- Issue 19: Agent added hallucinated "AI Agent Consultation Tool" to EXECUTION_PLAN.md

**Enforcement:** Pre-commit hook rejects commits that modify protected files from non-owner commits.

### Owner Mandates

`owner-mandates.json` lists steps and features explicitly directed by the project owner:

```json
{
  "mandatedSteps": ["6.5", "11b", "22"],
  "mandatedFeatures": [
    {
      "feature": "Settings page with model selection",
      "description": "...",
      "rationale": "..."
    }
  ]
}
```

**If a step or feature is mandated:**
- Codex must NOT raise scope or plan-alignment CRs
- Technical correctness, safety, and test coverage CRs remain valid
- Claude Code must NOT defer or reinterpret the scope
- Any proposal that doesn't match the mandate must be rejected

---

## 4. Review Files (Legacy Mode)

*Note: In Branch + PR mode (recommended), reviews happen on the PR diff instead of these files.*

| File | Author | Format |
|------|--------|--------|
| `ENG_REVIEW_RESPONSE.md` | Claude Code | Proposal or CR response |
| `ENG_REVIEW_COMMENTS.md` | Codex | CRs in standard format |

**Before writing:** archive the previous version to `reviews/` with a timestamp suffix.

**CR format:**
```markdown
### CR-NNN: <title>
- **ID**: CR-NNN
- **Round**: N
- **Severity**: critical | high | medium | low
- **Category**: correctness | reliability | security | quality | test-coverage
- **File(s)**: path:line
- **Status**: open

<description and proposed fix>
```

---

## 5. CODEBASE.md

Every repo using this protocol must maintain `CODEBASE.md`:
- File map with key sections and line numbers
- Event/API catalog
- Per-step location index ("Step X touches file.ts:100-150")

**Agents must read `CODEBASE.md` before reading any source file.** Use the line numbers to target reads — never read a full large file from scratch.

---

## 6. Commits and Pushes

Only the loop script commits and pushes. Agents write files but do not run git.

Commit message format: `Review loop: Step <N> <action>`

---

## 7. Escalation

The script escalates (messages the owner) when:
- State is in an unknown/invalid transition
- Agent flag is rejected 3+ times in a row
- Lock is stale > 45 min with no active process
- Any agent directly modifies `.review-loop-state.json`
- `nextAgent: "escalate"` is written (agent signals external blocker)
- Protected file modification is attempted

---

## 8. Quality Gates (per execution)

Before writing an `executed` flag, Claude Code must pass:
1. `tsc --noEmit` — 0 errors
2. `npm run lint` (or equivalent) — 0 errors
3. `npm test` (or equivalent) — all tests pass, no regressions

**No real API calls in automated tests.** All tests must use fake/mock data. Real API calls are expensive, slow, flaky, and blocked the build loop when they failed (Issue 20).

Codex must re-run these before writing `verified-clean`.

---

## Appendix: Common Failures & Fixes

### Issue 14: State file fabrication
**What:** Agent wrote `.review-loop-state.json` directly, marking fake Step 20 as complete.  
**Fix:** Script validates state transitions; agents never write state file.  
**Prevention:** Protected files enforcement.

### Issue 15: Watchdog session drift
**What:** Kimi session accumulated 110k tokens, hallucinated "Pattern G" routing rule.  
**Fix:** Fresh session per cron run.  
**Prevention:** Never use persistent sessions for watchdogs.

### Issue 16: Missing cr-fix routing
**What:** Script routed `reviewed` status to `p1` instead of `cr-fix`.  
**Fix:** Exhaustive routing table with explicit `reviewed → cr-fix` branch.  
**Prevention:** Routing coverage test asserts all status values have handlers.

### Issue 17: Step suffix parsing
**What:** `"11b"` broke `--argjson cs "11b"` (invalid JSON).  
**Fix:** Use `grep -o '^[0-9]*'` to extract integer part.  
**Prevention:** Step name format validation + safe extraction function.

### Issue 19: Hallucinated step in EXECUTION_PLAN.md
**What:** Agent added "AI Agent Consultation Tool" as Step 22.  
**Fix:** Corrected plan, added mandate rejecting the hallucination.  
**Prevention:** Protected files (owner-only write).

### Issue 20: Invalid nextAgent when blocked
**What:** Agent wrote `nextAgent: "steve"` then `nextAgent: "archie"` when blocked on API key.  
**Fix:** Added `escalate` as valid nextAgent with explicit handler.  
**Prevention:** Valid escalation path defined in protocol.

### Issue 21: `local` outside function (twice)
**What:** `local` keyword in advance block crashed script.  
**Fix:** Removed `local`, use uppercase global variable.  
**Prevention:** `shellcheck` in pre-commit hook catches this instantly.

---

*Protocol version: 2.0*  
*Last updated: 2026-02-20*  
*See also: Architecture Vision, Guardrails Proposal*
